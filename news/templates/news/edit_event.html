{% extends 'website/base.html' %}
{% load i18n %}
{% load static %}

{% block head %}
    <link rel="stylesheet" type="text/css" href="{% static 'news/css/news_style.css' %}">
    <link href="{% static 'website/css/select2.min.css' %}" rel="stylesheet" />
    <style>
        .select-wrapper {
            display: none;
        }
        .select2 {
            margin-top: 30px;
        }
    </style>
{% endblock head %}

{% block content %}
    {% translate "Rediger arrangement" as trans_edit %}
    {% include "website/page_overview/content_title.html" with title=trans_edit %}

    {% include "news/_list_admin_banner.html" %}

    <form enctype="multipart/form-data" method="post" novalidate>
        <div class="section">
            <div class="container">
                <div class="card-panel">
                    <div class="row">
                        {% csrf_token %}
                        {{ form.non_field_errors }}
                        <div class="col s12">
                            <h5>{% trans "Innhold" %}</h5>
                            <div class="divider"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            {{ form.title }}
                            <label for="{{ form.title.id_for_label }}">{{ form.title.label }}</label>
                            <span class="helper-text hs-red-text">{{ form.title.errors }}</span>
                            {{ form.title.help_text }}
                        </div>
                        <div class="input-field col s12">
                            {{ form.ingress_content }}
                            <label for="id_ingress_content">{{ form.ingress_content.label }}</label>
                            <span class="helper-text">{{ form.ingress_content.help_text }}</span>
                            <span class="helper-text hs-red-text">{{ form.ingress_content.errors }}</span>
                        </div>
                        <div class="input-field col s12">
                            {% include "website/inputs/markdown.html" with form=form form_field=form.main_content%}
                        </div>
                    </div>
                </div>
                <div class="card-panel">
                    <div class="row">
                        <div class="col s12">
                            <h5>{% trans "Velg hovedbilde" %}</h5>
                            <div class="divider"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12">
                            {% include 'files/_gallery_include.html' %}
                        </div>
                    </div>
                </div>
                <div class="card-panel">
                    <div class="row">
                        <div class="col s12">
                            <h5>Generelt</h5>
                            <div class="divider"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 input-field">
                            <p>
                                <i class="material-icons prefix">card_membership</i>
                                <label>
                                    {{ form.internal }}
                                    <span>{% trans "Internt arrangement (Kun Hackerspace-medlemmer kan se arrangementet)" %}</span>
                                </label>
                            </p>
                            <span class="helper-text hs-red-text">{{ form.internal.errors }}</span>
                        </div>
                        <div class="col s12 input-field">
                            <i class="material-icons prefix">person</i>
                            <label for="responsible-list">{{ form.responsibles.label }}</label>
                            <div style="margin-top: 40px; margin-bottom: -20px;" class="helper-text hs-red-text">{{ form.responsibles.errors }}</div>
                            <select id="responsible-list" multiple name="responsibles"></select>
                        </div>
                        <div class="input-field col s12 m6">
                            <i class="material-icons prefix">date_range</i>
                            {{ form.time_start }}
                            <label for="id_time_start">{{ form.time_start.label }}</label>
                            <span class="helper-text hs-red-text">{{ form.time_start.errors }}</span>
                        </div>

                        <div class="input-field col s12 m6">
                            <i class="material-icons prefix">date_range</i>
                            {{ form.time_end }}
                            <label for="id_time_end">{{ form.time_end.label }}</label>
                            <span class="helper-text hs-red-text">{{ form.time_end.errors }}</span>
                        </div>
                        <div class="input-field col s12 m6">
                            <i class="material-icons prefix">location_on</i>
                            {{ form.place }}
                            <label for="id_place">{{ form.place.label }}</label>
                            <span class="helper-text hs-red-text">{{ form.place.errors }}</span>
                        </div>
                        <div class="input-field col s12 m6">
                            <i class="material-icons prefix">link</i>
                            {{ form.place_href }}
                            <label for="id_place_href">{{ form.place_href.label }}</label>
                            <span class="helper-text hs-red-text">{{ form.place_href.errors }}</span>
                        </div>
                        <div class="col s12 input-field">
                            <p>
                                <i class="material-icons prefix">fastfood</i>
                                <label>
                                    {{ form.servering }}
                                    <span>{{ form.servering.label }}</span>
                                </label>
                            </p>
                            <span class="helper-text hs-red-text">{{ form.servering.errors }}</span>
                        </div>
                        <div class="col s12 input-field">
                            <p>
                                <i class="material-icons prefix">group_add</i>
                                <label>
                                    {{ form.registration }}
                                    <span>{{ form.registration.label }}</span>
                                </label>
                            </p>
                            <span class="helper-text hs-red-text">{{ form.registration.errors }}</span>
                        </div>
                        <div class="col s12 input-field ext-reg">
                            {{ form.external_registration }}
                            <label for="id_external_registration">{{ form.external_registration.label }}</label>
                            <span class="helper-text">La stå tom dersom arrangementet ikke behøver påmelding.</span>
                            <span class="helper-text hs-red-text">{{ form.external_registration.errors }}</span>
                        </div>
                    </div>
                </div>
                <div class="card-panel reg-box">
                    <div class="row">
                        <div class="col s12">
                            <h5>{% trans "Påmelding" %}</h5>
                            <div class="divider"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <i class="material-icons prefix">event_seat</i>
                            {{ form.max_limit }}
                            <label for="id_max_limit">{{ form.max_limit.label }}</label>
                            <span class="helper-text hs-red-text">{{ form.max_limit.errors }}</span>
                        </div>
                        <div class="input-field col s12 m6">
                            <i class="material-icons prefix">event_available</i>
                            {{ form.registration_start }}
                            <label for="id_registration_start">{{ form.registration_start.label }}</label>
                            <span class="helper-text hs-red-text">{{ form.registration_start.errors }}</span>
                        </div>
                        <div class="input-field col s12 m6">
                            <i class="material-icons prefix">event_available</i>
                            {{ form.registration_end }}
                            <label for="id_registration_end">{{ form.registration_end.label }}</label>
                            <span class="helper-text hs-red-text">{{ form.registration_end.errors }}</span>
                        </div>
                        <div class="input-field col s12 m6">
                            <i class="material-icons prefix">event_busy</i>
                            {{ form.deregistration_end }}
                            <label for="id_deregistration_end">{{ form.deregistration_end.label }}</label>
                            <span class="helper-text hs-red-text">{{ form.deregistration_end.errors }}</span>
                        </div>
                    </div>
                </div>
                <div class="card-panel reg-box">
                    <div class="row">
                        <div class="col s12">
                            <h5>{% trans "Ferdigheter" %}</h5>
                            <p>Dersom arrangementet er et kurs, kan du legge inn ferdighetene som læres bort her.
                                De vil automatisk legges til alle med registrert oppmøte.</p>
                            <div class="divider"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            {{ form.skills }}
                            <label for="id_skills">{{ form.skills.label }}</label>
                            <span class="helper-text hs-red-text">{{ form.skills.errors }}</span>
                        </div>
                    </div>
                </div>
                <div class="card-panel">
                    <div class="row">
                        <div class="col s12">
                            <h5>{% trans "Filer" %}</h5>
                            <p>{% trans "Det kan være nyttig å legge ved powerpoint eller andre relevante filer i arrangementet. Da får deltakerene mulighet til å gjøre seg klare før arrangementet starter." %}</p>
                            <div class="divider"></div>
                            <br>
                        </div>
                        {{ uploads_form.management_form }}
                        {% for form in uploads_form %}
                            <div class="input-field col s12">
                                {{ form.id }}
                                {{ form.title }}
                                <label for="id_title">{{ form.title.label }}</label>
                                {{ form.file }}
                                <span class="helper-text hs-red-text">{{ form.file.errors }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-panel">
                    <div class="row">
                        <div class="col s12">
                            <h5>{% trans "Ferdig" %}</h5>
                            <div class="divider"></div>
                            <br>
                            <div class="hide col s12 input-field">
                                <div class="col s12">
                                    <p>
                                        <label>
                                            {{ form.draft }}
                                            <span>{{ form.draft.label }}</span>
                                        </label>
                                    </p>
                                    <span class="helper-text hs-red-text">{{ form.internal.errors }}</span>
                                </div>
                            </div>
                            <button id="submit" class="hide btn btn-large hs-green waves-effect waves-light" type="submit"
                                name="form_submit">{% trans "Lagre og publiser arrangement" %}
                            </button>
                            <a class="btn btn-large hs-green waves-effect waves-light" onclick="saveAndPublish()">
                                {% trans "Lagre og publiser arrangement" %}
                            </a>
                            <a class="btn btn-large hs-gray waves-effect waves-light" onclick="saveAsDraft()">
                                {% trans "Lagre som utkast" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <script src="{% static 'website/js/select2.min.js' %}" type="text/javascript" ></script>
    <script>
        const data = [];
        {% for responsible in responsibles.all %}
            data.push({
                id: "{{ responsible.id }}",
                text: "{{ responsible.get_full_name }}",
                selected: true
            })
        {% endfor %}

        $("#responsible-list").select2({
            data: data,
            language: {
                errorLoading: () => '{% trans "Kunne ikke hente flere resultater" %}',
                inputTooShort: () => '{% trans "Vennligst skriv inn flere tegn" %}',
                inputTooLong: () => '{% trans "Vennligst skriv inn færre tegn" %}',
                loadingMore: () => '{% trans "Laster flere resultater" %}',
                maximumSelected: () => '{% trans "Du kan ikke velge flere" %}',
                noResults: () => '{% trans "Ingen resultater" %}',
                removeAllItems: () => '{% trans "Fjern alle" %}',
            },
            ajax: {
                url: (params) => `/api/user-search?page-size=10&query=${params.term ?? ''}`,
                dataType: "json",
                processResults: (res) => {
                    return {
                        results: res.map((usr) => ({
                            id: usr["id"],
                            text: `${usr["first_name"]} ${usr["last_name"]}`
                        }))}
                },
            }
        })
    </script>
    <script src="{% static 'news/js/edit_event.js' %}"></script>
    <script src="{% static 'website/js/datetimepicker.js' %}"></script>
    <script src="{% static 'news/js/save_draft_or_publish.js' %}"></script>

{% endblock content %}
